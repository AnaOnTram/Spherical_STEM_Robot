<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spherical Robot Control</title>
    
    <!-- Material Design 3 -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            /* Material Design 3 Color System */
            --md-sys-color-primary: #6750A4;
            --md-sys-color-on-primary: #FFFFFF;
            --md-sys-color-primary-container: #EADDFF;
            --md-sys-color-on-primary-container: #21005D;
            
            --md-sys-color-secondary: #625B71;
            --md-sys-color-on-secondary: #FFFFFF;
            --md-sys-color-secondary-container: #E8DEF8;
            --md-sys-color-on-secondary-container: #1D192B;
            
            --md-sys-color-tertiary: #7D5260;
            --md-sys-color-on-tertiary: #FFFFFF;
            --md-sys-color-tertiary-container: #FFD8E4;
            --md-sys-color-on-tertiary-container: #31111D;
            
            --md-sys-color-error: #B3261E;
            --md-sys-color-on-error: #FFFFFF;
            --md-sys-color-error-container: #F9DEDC;
            --md-sys-color-on-error-container: #410E0B;
            
            --md-sys-color-surface: #FFFBFE;
            --md-sys-color-on-surface: #1C1B1F;
            --md-sys-color-surface-variant: #E7E0EC;
            --md-sys-color-on-surface-variant: #49454F;
            
            --md-sys-color-outline: #79747E;
            --md-sys-color-outline-variant: #CAC4D0;
            
            /* Elevation */
            --md-sys-elevation-level0: 0px 0px 0px 0px rgba(0,0,0,0);
            --md-sys-elevation-level1: 0px 1px 2px 0px rgba(0,0,0,0.3), 0px 1px 3px 1px rgba(0,0,0,0.15);
            --md-sys-elevation-level2: 0px 1px 2px 0px rgba(0,0,0,0.3), 0px 2px 6px 2px rgba(0,0,0,0.15);
            --md-sys-elevation-level3: 0px 1px 3px 0px rgba(0,0,0,0.3), 0px 4px 8px 3px rgba(0,0,0,0.15);
            
            /* Shape */
            --md-sys-shape-corner-extra-small: 4px;
            --md-sys-shape-corner-small: 8px;
            --md-sys-shape-corner-medium: 12px;
            --md-sys-shape-corner-large: 16px;
            --md-sys-shape-corner-extra-large: 28px;
            --md-sys-shape-corner-full: 50%;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            line-height: 1.5;
        }
        
        /* App Bar */
        .app-bar {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
            padding: 16px 24px;
            box-shadow: var(--md-sys-elevation-level2);
            display: flex;
            align-items: center;
            gap: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .app-bar h1 {
            font-size: 22px;
            font-weight: 400;
            flex: 1;
        }
        
        .app-bar .material-icons {
            font-size: 24px;
        }
        
        /* Connection Status Chip */
        .connection-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 16px;
            border-radius: var(--md-sys-shape-corner-small);
            font-size: 14px;
            font-weight: 500;
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .connection-chip:hover {
            background-color: var(--md-sys-color-secondary-container);
        }
        
        .connection-chip.connected {
            background-color: #4CAF50;
            color: white;
        }
        
        .connection-chip.disconnected {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
        }
        
        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        
        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }
        
        /* Cards */
        .card {
            background-color: var(--md-sys-color-surface);
            border-radius: var(--md-sys-shape-corner-large);
            box-shadow: var(--md-sys-elevation-level1);
            overflow: hidden;
            transition: box-shadow 0.2s;
        }
        
        .card:hover {
            box-shadow: var(--md-sys-elevation-level2);
        }
        
        .card-header {
            padding: 16px 24px;
            background-color: var(--md-sys-color-surface-variant);
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .card-header .material-icons {
            font-size: 24px;
            color: var(--md-sys-color-primary);
        }
        
        .card-header h2 {
            font-size: 16px;
            font-weight: 500;
            color: var(--md-sys-color-on-surface-variant);
        }
        
        .card-content {
            padding: 24px;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 24px;
            border: none;
            border-radius: var(--md-sys-shape-corner-full);
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: currentColor;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .btn:hover::before {
            opacity: 0.08;
        }
        
        .btn:active::before {
            opacity: 0.12;
        }
        
        .btn:disabled {
            opacity: 0.38;
            cursor: not-allowed;
        }
        
        .btn-filled {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }
        
        .btn-tonal {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }
        
        .btn-outlined {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            border: 1px solid var(--md-sys-color-outline);
        }
        
        .btn-text {
            background-color: transparent;
            color: var(--md-sys-color-primary);
            padding: 10px 12px;
        }
        
        .btn-error {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
        }
        
        /* Icon Buttons */
        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--md-sys-shape-corner-full);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            background-color: transparent;
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .icon-btn:hover {
            background-color: var(--md-sys-color-surface-variant);
        }
        
        .icon-btn.filled {
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
        }
        
        /* FAB (Floating Action Button) */
        .fab {
            width: 56px;
            height: 56px;
            border-radius: var(--md-sys-shape-corner-large);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            box-shadow: var(--md-sys-elevation-level3);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .fab:hover {
            box-shadow: var(--md-sys-elevation-level2);
        }
        
        .fab .material-icons {
            font-size: 24px;
        }
        
        /* Text Fields */
        .text-field {
            position: relative;
            margin-bottom: 16px;
        }
        
        .text-field input,
        .text-field textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-small);
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            transition: all 0.2s;
        }
        
        .text-field input:focus,
        .text-field textarea:focus {
            outline: none;
            border-color: var(--md-sys-color-primary);
            border-width: 2px;
        }
        
        .text-field textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Sliders */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 16px 0;
        }
        
        .slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background-color: var(--md-sys-color-surface-variant);
            border-radius: 2px;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background-color: var(--md-sys-color-primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--md-sys-elevation-level1);
        }
        
        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background-color: var(--md-sys-color-primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: var(--md-sys-elevation-level1);
        }
        
        /* Video Container */
        .video-container {
            background-color: #000;
            border-radius: var(--md-sys-shape-corner-medium);
            overflow: hidden;
            aspect-ratio: 4/3;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .video-container img,
        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .video-placeholder {
            color: var(--md-sys-color-on-surface-variant);
            text-align: center;
        }
        
        /* D-Pad */
        .dpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-width: 200px;
            margin: 0 auto;
        }
        
        .dpad-btn {
            width: 64px;
            height: 64px;
            border-radius: var(--md-sys-shape-corner-medium);
            border: none;
            background-color: var(--md-sys-color-surface-variant);
            color: var(--md-sys-color-on-surface-variant);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            user-select: none;
        }
        
        .dpad-btn:hover {
            background-color: var(--md-sys-color-secondary-container);
        }
        
        .dpad-btn:active {
            background-color: var(--md-sys-color-primary-container);
        }
        
        .dpad-btn .material-icons {
            font-size: 32px;
        }
        
        .dpad-btn.stop {
            background-color: var(--md-sys-color-error-container);
            color: var(--md-sys-color-on-error-container);
        }
        
        /* Segmented Button */
        .segmented-btn {
            display: inline-flex;
            background-color: var(--md-sys-color-surface-variant);
            border-radius: var(--md-sys-shape-corner-full);
            padding: 4px;
            gap: 4px;
        }
        
        .segmented-btn button {
            padding: 8px 16px;
            border: none;
            background-color: transparent;
            color: var(--md-sys-color-on-surface-variant);
            border-radius: var(--md-sys-shape-corner-full);
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .segmented-btn button.active {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }
        
        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--md-sys-color-outline);
            border-radius: var(--md-sys-shape-corner-large);
            padding: 48px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: var(--md-sys-color-surface);
        }
        
        .upload-area:hover {
            border-color: var(--md-sys-color-primary);
            background-color: var(--md-sys-color-primary-container);
        }
        
        .upload-area .material-icons {
            font-size: 48px;
            color: var(--md-sys-color-primary);
            margin-bottom: 16px;
        }
        
        /* Status Snackbar */
        .snackbar {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--md-sys-color-on-surface);
            color: var(--md-sys-color-surface);
            padding: 14px 24px;
            border-radius: var(--md-sys-shape-corner-small);
            box-shadow: var(--md-sys-elevation-level3);
            display: flex;
            align-items: center;
            gap: 16px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .snackbar.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        /* Dialog */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .dialog-overlay.show {
            display: flex;
        }
        
        .dialog {
            background-color: var(--md-sys-color-surface);
            border-radius: var(--md-sys-shape-corner-extra-large);
            padding: 24px;
            min-width: 320px;
            max-width: 90vw;
            box-shadow: var(--md-sys-elevation-level3);
        }
        
        .dialog h3 {
            font-size: 24px;
            font-weight: 400;
            margin-bottom: 16px;
        }
        
        .dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 24px;
        }
        
        /* Log Panel */
        .log-panel {
            background-color: var(--md-sys-color-surface-variant);
            border-radius: var(--md-sys-shape-corner-medium);
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Roboto Mono', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid var(--md-sys-color-outline-variant);
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-entry.error {
            color: var(--md-sys-color-error);
        }
        
        .log-entry.success {
            color: #4CAF50;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            
            .app-bar h1 {
                font-size: 18px;
            }
        }

        /* Alarm Pulse Animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <!-- App Bar -->
    <header class="app-bar">
        <span class="material-icons">smart_toy</span>
        <h1>Spherical Robot Control</h1>
        <div class="connection-chip disconnected" id="connectionChip" onclick="showConnectionDialog()">
            <span class="material-icons">link_off</span>
            <span id="connectionText">Disconnected</span>
        </div>
    </header>
    
    <main class="container">
        <!-- Connection Dialog -->
        <div class="dialog-overlay" id="connectionDialog">
            <div class="dialog">
                <h3>Connect to Robot</h3>
                <div class="text-field">
                    <input type="text" id="apiHostInput" placeholder="192.168.1.100:8000" value="">
                </div>
                <div class="dialog-actions">
                    <button class="btn btn-text" onclick="hideConnectionDialog()">Cancel</button>
                    <button class="btn btn-filled" onclick="connect()">Connect</button>
                </div>
            </div>
        </div>
        
        <div class="grid">
            <!-- Video Stream -->
            <div class="card">
                <div class="card-header">
                    <span class="material-icons">videocam</span>
                    <h2>Video Stream</h2>
                </div>
                <div class="card-content">
                    <div class="video-container" id="videoContainer">
                        <div class="video-placeholder">
                            <span class="material-icons" style="font-size: 48px; opacity: 0.5;">videocam_off</span>
                            <p>Stream not active</p>
                        </div>
                    </div>
                    <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: center;">
                        <button class="btn btn-filled" onclick="startVideo()">
                            <span class="material-icons">play_arrow</span>
                            Start
                        </button>
                        <button class="btn btn-outlined" onclick="stopVideo()">
                            <span class="material-icons">stop</span>
                            Stop
                        </button>
                        <button class="btn btn-tonal" onclick="takeSnapshot()">
                            <span class="material-icons">camera</span>
                            Snapshot
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Audio Stream -->
            <div class="card">
                <div class="card-header">
                    <span class="material-icons">mic</span>
                    <h2>Audio Monitor</h2>
                </div>
                <div class="card-content">
                    <div style="text-align: center; padding: 32px;">
                        <div id="audioVisualizer" style="height: 60px; display: flex; align-items: center; justify-content: center; gap: 4px;">
                            <div style="width: 4px; height: 20px; background-color: var(--md-sys-color-primary); border-radius: 2px;"></div>
                            <div style="width: 4px; height: 40px; background-color: var(--md-sys-color-primary); border-radius: 2px;"></div>
                            <div style="width: 4px; height: 30px; background-color: var(--md-sys-color-primary); border-radius: 2px;"></div>
                            <div style="width: 4px; height: 50px; background-color: var(--md-sys-color-primary); border-radius: 2px;"></div>
                            <div style="width: 4px; height: 25px; background-color: var(--md-sys-color-primary); border-radius: 2px;"></div>
                        </div>
                        <p id="audioStatus" style="margin-top: 16px; color: var(--md-sys-color-on-surface-variant);">Audio stream stopped</p>
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: center;">
                        <button class="btn btn-filled" onclick="startAudio()">
                            <span class="material-icons">volume_up</span>
                            Listen
                        </button>
                        <button class="btn btn-outlined" onclick="stopAudio()">
                            <span class="material-icons">volume_off</span>
                            Mute
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Movement Control -->
            <div class="card">
                <div class="card-header">
                    <span class="material-icons">gamepad</span>
                    <h2>Movement Control</h2>
                </div>
                <div class="card-content">
                    <div class="dpad">
                        <div></div>
                        <button class="dpad-btn" onmousedown="move(0, 1)" onmouseup="stopMotors()" ontouchstart="move(0, 1)" ontouchend="stopMotors()">
                            <span class="material-icons">arrow_upward</span>
                        </button>
                        <div></div>
                        <button class="dpad-btn" onmousedown="move(-1, 0)" onmouseup="stopMotors()" ontouchstart="move(-1, 0)" ontouchend="stopMotors()">
                            <span class="material-icons">arrow_back</span>
                        </button>
                        <button class="dpad-btn stop" onclick="stopMotors()">
                            <span class="material-icons">stop</span>
                        </button>
                        <button class="dpad-btn" onmousedown="move(1, 0)" onmouseup="stopMotors()" ontouchstart="move(1, 0)" ontouchend="stopMotors()">
                            <span class="material-icons">arrow_forward</span>
                        </button>
                        <div></div>
                        <button class="dpad-btn" onmousedown="move(0, -1)" onmouseup="stopMotors()" ontouchstart="move(0, -1)" ontouchend="stopMotors()">
                            <span class="material-icons">arrow_downward</span>
                        </button>
                        <div></div>
                    </div>
                    
                    <div class="slider-container" style="margin-top: 24px;">
                        <span class="material-icons">speed</span>
                        <input type="range" class="slider" id="speedSlider" min="50" max="255" value="150">
                        <span id="speedValue" style="min-width: 40px; text-align: right;">150</span>
                    </div>
                </div>
            </div>
            
            <!-- E-Ink Display -->
            <div class="card">
                <div class="card-header">
                    <span class="material-icons">display_settings</span>
                    <h2>E-Ink Display</h2>
                </div>
                <div class="card-content">
                    <div class="upload-area" onclick="document.getElementById('displayImageInput').click()">
                        <span class="material-icons">cloud_upload</span>
                        <p style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">Upload Image</p>
                        <p style="font-size: 14px; color: var(--md-sys-color-on-surface-variant);">400√ó300 pixels, B&W</p>
                    </div>
                    <input type="file" id="displayImageInput" accept="image/*" style="display: none;" onchange="handleDisplayImageUpload(this)">
                    
                    <div class="text-field" style="margin-top: 16px;">
                        <textarea id="displayText" placeholder="Enter text to display..."></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-filled" onclick="sendDisplayText()">
                            <span class="material-icons">text_fields</span>
                            Text
                        </button>
                        <button class="btn btn-tonal" onclick="sendPattern()">
                            <span class="material-icons">pattern</span>
                            Pattern
                        </button>
                        <button class="btn btn-error" onclick="clearDisplay()">
                            <span class="material-icons">clear</span>
                            Clear
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Audio Messages -->
            <div class="card">
                <div class="card-header">
                    <span class="material-icons">record_voice_over</span>
                    <h2>Audio Messages</h2>
                </div>
                <div class="card-content">
                    <div style="text-align: center; padding: 24px;">
                        <button class="fab" id="recordBtn" onmousedown="startRecording()" onmouseup="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()">
                            <span class="material-icons">mic</span>
                        </button>
                        <p id="recordHint" style="margin-top: 16px; color: var(--md-sys-color-on-surface-variant);">Hold to record</p>
                        <p id="recordingTime" style="font-size: 24px; font-weight: 500; color: var(--md-sys-color-error); display: none;">0:00</p>
                    </div>
                    
                    <div class="upload-area" onclick="document.getElementById('audioFileInput').click()" style="padding: 24px;">
                        <span class="material-icons">audio_file</span>
                        <p style="font-size: 14px; color: var(--md-sys-color-on-surface-variant);">Upload MP3/WAV</p>
                    </div>
                    <input type="file" id="audioFileInput" accept=".mp3,.wav,.ogg" style="display: none;" onchange="uploadAudioFile(this)">
                </div>
            </div>
            
            <!-- Alarm Control -->
            <div class="card">
                <div class="card-header">
                    <span class="material-icons">notification_important</span>
                    <h2>Alarm Control</h2>
                </div>
                <div class="card-content">
                    <!-- Alarm Status Indicator -->
                    <div id="alarmStatusPanel" style="background-color: var(--md-sys-color-surface-variant); border-radius: var(--md-sys-shape-corner-medium); padding: 16px; margin-bottom: 16px; text-align: center;">
                        <div id="alarmIcon" style="font-size: 48px; margin-bottom: 8px;">üîá</div>
                        <div id="alarmStateText" style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">Unknown</div>
                        <div style="display: flex; justify-content: center; gap: 24px; font-size: 14px; color: var(--md-sys-color-on-surface-variant);">
                            <span>Threshold: <span id="alarmThreshold">--</span></span>
                            <span>Duration: <span id="alarmDuration">--</span>s</span>
                        </div>
                    </div>
                    
                    <!-- Alarm Actions -->
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-bottom: 16px;">
                        <button class="btn btn-filled" onclick="enableAlarm()">
                            <span class="material-icons">notifications_active</span>
                            Enable
                        </button>
                        <button class="btn btn-outlined" onclick="disableAlarm()">
                            <span class="material-icons">notifications_off</span>
                            Disable
                        </button>
                        <button class="btn btn-tonal" onclick="acknowledgeAlarm()">
                            <span class="material-icons">check_circle</span>
                            Ack
                        </button>
                        <button class="btn btn-error" onclick="testAlarm()">
                            <span class="material-icons">campaign</span>
                            Test
                        </button>
                    </div>
                    
                    <!-- Configuration -->
                    <details style="margin-bottom: 16px;">
                        <summary style="cursor: pointer; color: var(--md-sys-color-on-surface-variant); padding: 8px 0;">‚öôÔ∏è Configuration</summary>
                        <div style="padding: 16px; background-color: var(--md-sys-color-surface-variant); border-radius: var(--md-sys-shape-corner-medium); margin-top: 8px;">
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 12px; color: var(--md-sys-color-on-surface-variant); margin-bottom: 4px;">Threshold (0.0-1.0)</label>
                                <input type="number" id="configThreshold" value="0.8" min="0" max="1" step="0.05" style="width: 100%; padding: 8px; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-shape-corner-small);">
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-size: 12px; color: var(--md-sys-color-on-surface-variant); margin-bottom: 4px;">Duration (seconds)</label>
                                <input type="number" id="configDuration" value="3" min="1" max="30" style="width: 100%; padding: 8px; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-shape-corner-small);">
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-filled" onclick="updateAlarmConfig()" style="flex: 1;">Save</button>
                                <button class="btn btn-outlined" onclick="loadAlarmConfig()" style="flex: 1;">Refresh</button>
                            </div>
                        </div>
                    </details>
                    
                    <!-- Webhook Settings -->
                    <details>
                        <summary style="cursor: pointer; color: var(--md-sys-color-on-surface-variant); padding: 8px 0;">üîó Webhook Settings</summary>
                        <div style="padding: 16px; background-color: var(--md-sys-color-surface-variant); border-radius: var(--md-sys-shape-corner-medium); margin-top: 8px;">
                            <input type="text" id="webhookUrl" placeholder="https://your-api.com/alerts" style="width: 100%; padding: 8px; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-shape-corner-small); margin-bottom: 12px;">
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-filled" onclick="setWebhook()" style="flex: 1;">Set Webhook</button>
                                <button class="btn btn-outlined" onclick="clearWebhook()" style="flex: 1;">Clear</button>
                            </div>
                        </div>
                    </details>
                </div>
            </div>

            <!-- Detection History -->
            <div class="card">
                <div class="card-header">
                    <span class="material-icons">history</span>
                    <h2>Detection History</h2>
                </div>
                <div class="card-content">
                    <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                        <select id="historyFilter" onchange="loadDetectionHistory()" style="flex: 1; padding: 8px; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-shape-corner-small);">
                            <option value="">All Events</option>
                            <option value="alarm_triggered">Alarms Only</option>
                            <option value="crying_detected">Crying Detected</option>
                            <option value="crying_confirmed">Crying Confirmed</option>
                        </select>
                        <button class="btn btn-tonal" onclick="loadDetectionHistory()">
                            <span class="material-icons">refresh</span>
                        </button>
                        <button class="btn btn-outlined" onclick="clearHistory()">
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                    <div id="historyList" style="max-height: 200px; overflow-y: auto; background-color: var(--md-sys-color-surface-variant); border-radius: var(--md-sys-shape-corner-medium); padding: 12px;">
                        <div style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: 20px;">No events recorded</div>
                    </div>
                </div>
            </div>

            <!-- System Status -->
            <div class="card">
                <div class="card-header">
                    <span class="material-icons">settings</span>
                    <h2>System Status</h2>
                </div>
                <div class="card-content">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 16px;">
                        <div style="text-align: center; padding: 16px; background-color: var(--md-sys-color-surface-variant); border-radius: var(--md-sys-shape-corner-medium);">
                            <span class="material-icons" style="font-size: 32px; color: var(--md-sys-color-primary);">memory</span>
                            <p style="font-size: 12px; color: var(--md-sys-color-on-surface-variant); margin-top: 8px;">ESP32</p>
                            <p id="esp32Status" style="font-weight: 500;">--</p>
                        </div>
                        <div style="text-align: center; padding: 16px; background-color: var(--md-sys-color-surface-variant); border-radius: var(--md-sys-shape-corner-medium);">
                            <span class="material-icons" style="font-size: 32px; color: var(--md-sys-color-primary);">videocam</span>
                            <p style="font-size: 12px; color: var(--md-sys-color-on-surface-variant); margin-top: 8px;">Video</p>
                            <p id="videoStatus" style="font-weight: 500;">--</p>
                        </div>
                        <div style="text-align: center; padding: 16px; background-color: var(--md-sys-color-surface-variant); border-radius: var(--md-sys-shape-corner-medium);">
                            <span class="material-icons" style="font-size: 32px; color: var(--md-sys-color-primary);">mic</span>
                            <p style="font-size: 12px; color: var(--md-sys-color-on-surface-variant); margin-top: 8px;">Audio</p>
                            <p id="audioStatus" style="font-weight: 500;">--</p>
                        </div>
                        <div style="text-align: center; padding: 16px; background-color: var(--md-sys-color-surface-variant); border-radius: var(--md-sys-shape-corner-medium);">
                            <span class="material-icons" style="font-size: 32px; color: var(--md-sys-color-primary);">notification_important</span>
                            <p style="font-size: 12px; color: var(--md-sys-color-on-surface-variant); margin-top: 8px;">Alarm</p>
                            <p id="alarmStatus" style="font-weight: 500;">--</p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; justify-content: center;">
                        <button class="btn btn-tonal" onclick="pingESP32()">
                            <span class="material-icons">sports_tennis</span>
                            Ping
                        </button>
                        <button class="btn btn-outlined" onclick="resetESP32()">
                            <span class="material-icons">restart_alt</span>
                            Reset
                        </button>
                        <button class="btn btn-text" onclick="refreshStatus()">
                            <span class="material-icons">refresh</span>
                            Refresh
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Log Panel -->
            <div class="card" style="grid-column: 1 / -1;">
                <div class="card-header">
                    <span class="material-icons">terminal</span>
                    <h2>System Log</h2>
                    <button class="icon-btn" onclick="clearLog()" style="margin-left: auto;">
                        <span class="material-icons">clear_all</span>
                    </button>
                </div>
                <div class="card-content">
                    <div class="log-panel" id="logPanel">
                        <div class="log-entry">System ready. Connect to robot to begin.</div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Snackbar -->
    <div class="snackbar" id="snackbar">
        <span id="snackbarText">Message</span>
        <button class="btn btn-text" onclick="hideSnackbar()" style="color: inherit;">Dismiss</button>
    </div>
    
    <script>
        // State
        let apiBase = '';
        let isConnected = false;
        let ws = null;
        let audioWs = null;
        
        // DOM Elements
        const connectionChip = document.getElementById('connectionChip');
        const connectionText = document.getElementById('connectionText');
        const logPanel = document.getElementById('logPanel');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        
        // Speed slider
        speedSlider.addEventListener('input', () => {
            speedValue.textContent = speedSlider.value;
        });
        
        // Logging
        function log(message, type = 'info') {
            console.log(`[${type}] ${message}`);
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }
        
        function clearLog() {
            logPanel.innerHTML = '<div class="log-entry">Log cleared.</div>';
        }
        
        // Snackbar
        function showSnackbar(message) {
            const snackbar = document.getElementById('snackbar');
            document.getElementById('snackbarText').textContent = message;
            snackbar.classList.add('show');
            setTimeout(hideSnackbar, 4000);
        }
        
        function hideSnackbar() {
            document.getElementById('snackbar').classList.remove('show');
        }
        
        // Connection Dialog
        function showConnectionDialog() {
            document.getElementById('connectionDialog').classList.add('show');
        }
        
        function hideConnectionDialog() {
            document.getElementById('connectionDialog').classList.remove('show');
        }
        
        // API Calls
        async function apiCall(endpoint, method = 'GET', body = null) {
            if (!apiBase) {
                showSnackbar('Not connected to robot');
                return null;
            }
            
            const url = `http://${apiBase}${endpoint}`;
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                log(`API Error: ${error.message}`, 'error');
                return null;
            }
        }
        
        // Connect
        async function connect() {
            const host = document.getElementById('apiHostInput').value;
            if (!host) {
                showSnackbar('Please enter robot IP address');
                return;
            }
            
            apiBase = host;
            
            // Test connection
            try {
                const response = await fetch(`http://${apiBase}/health`);
                if (response.ok) {
                    isConnected = true;
                    connectionChip.classList.remove('disconnected');
                    connectionChip.classList.add('connected');
                    connectionText.textContent = 'Connected';
                    connectionChip.querySelector('.material-icons').textContent = 'link';
                    hideConnectionDialog();
                    log('Connected to robot');
                    showSnackbar('Connected successfully');
                    refreshStatus();
                }
            } catch (error) {
                showSnackbar('Connection failed');
                log('Connection failed', 'error');
            }
        }
        
        // Movement
        async function move(x, y) {
            const speed = parseInt(speedSlider.value);
            const left = Math.round(y * speed + x * speed * 0.5);
            const right = Math.round(y * speed - x * speed * 0.5);
            await apiCall('/api/movement/move', 'POST', { left_speed: left, right_speed: right, duration_ms: 0 });
        }
        
        async function stopMotors() {
            await apiCall('/api/movement/stop', 'POST');
        }
        
        // Video
        let videoStream = null;
        
        function startVideo() {
            const container = document.getElementById('videoContainer');
            container.innerHTML = `<img src="http://${apiBase}/api/stream/video" style="width: 100%; height: 100%; object-fit: contain;">`;
            log('Video stream started');
        }
        
        function stopVideo() {
            const container = document.getElementById('videoContainer');
            container.innerHTML = `
                <div class="video-placeholder">
                    <span class="material-icons" style="font-size: 48px; opacity: 0.5;">videocam_off</span>
                    <p>Stream not active</p>
                </div>
            `;
            log('Video stream stopped');
        }
        
        async function takeSnapshot() {
            const response = await fetch(`http://${apiBase}/api/stream/snapshot`);
            if (response.ok) {
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `snapshot_${Date.now()}.jpg`;
                a.click();
                showSnackbar('Snapshot saved');
            }
        }
        
        // Audio
        let audioContext = null;
        let audioGainNode = null;
        
        async function startAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioGainNode = audioContext.createGain();
                audioGainNode.connect(audioContext.destination);
            }
            
            const wsUrl = `ws://${apiBase}/ws/audio`;
            audioWs = new WebSocket(wsUrl);
            audioWs.binaryType = 'arraybuffer';
            
            audioWs.onmessage = async (event) => {
                if (typeof event.data === 'string') {
                    // Config message
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'audio_config') {
                        log(`Audio: ${msg.sample_rate}Hz`);
                    }
                } else {
                    // Audio data
                    const int16Array = new Int16Array(event.data);
                    const float32Array = new Float32Array(int16Array.length);
                    for (let i = 0; i < int16Array.length; i++) {
                        float32Array[i] = int16Array[i] / 32768.0;
                    }
                    
                    const audioBuffer = audioContext.createBuffer(1, float32Array.length, 48000);
                    audioBuffer.getChannelData(0).set(float32Array);
                    
                    const source = audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioGainNode);
                    source.start();
                }
            };
            
            document.getElementById('audioStatus').textContent = 'Listening...';
            log('Audio stream started');
        }
        
        function stopAudio() {
            if (audioWs) {
                audioWs.close();
                audioWs = null;
            }
            document.getElementById('audioStatus').textContent = 'Audio stream stopped';
            log('Audio stream stopped');
        }
        
        // Display
        async function sendDisplayText() {
            const text = document.getElementById('displayText').value;
            await apiCall('/api/display/update', 'POST', { text });
            showSnackbar('Text sent to display');
        }
        
        async function sendPattern() {
            const patterns = ['checkerboard', 'gradient', 'border'];
            const pattern = patterns[Math.floor(Math.random() * patterns.length)];
            await apiCall('/api/display/update', 'POST', { pattern });
            showSnackbar('Pattern sent to display');
        }
        
        async function clearDisplay() {
            await apiCall('/api/display/clear', 'POST');
            showSnackbar('Display cleared');
        }
        
        async function handleDisplayImageUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                const img = new Image();
                img.onload = async () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 400;
                    canvas.height = 300;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, 400, 300);
                    
                    const imageData = ctx.getImageData(0, 0, 400, 300);
                    const binaryData = floydSteinbergDither(imageData.data, 400, 300);
                    const base64Data = btoa(String.fromCharCode.apply(null, binaryData));
                    
                    await apiCall('/api/display/update', 'POST', { image_base64: base64Data });
                    showSnackbar('Image sent to display');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function floydSteinbergDither(data, width, height) {
            const gray = new Float32Array(width * height);
            for (let i = 0; i < width * height; i++) {
                gray[i] = data[i * 4] * 0.299 + data[i * 4 + 1] * 0.587 + data[i * 4 + 2] * 0.114;
            }
            
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const idx = y * width + x;
                    const oldPixel = gray[idx];
                    const newPixel = oldPixel < 128 ? 0 : 255;
                    const error = oldPixel - newPixel;
                    gray[idx] = newPixel;
                    
                    if (x + 1 < width) gray[idx + 1] += error * 7 / 16;
                    if (x - 1 >= 0 && y + 1 < height) gray[idx + width - 1] += error * 3 / 16;
                    if (y + 1 < height) gray[idx + width] += error * 5 / 16;
                    if (x + 1 < width && y + 1 < height) gray[idx + width + 1] += error * 1 / 16;
                }
            }
            
            const packed = new Uint8Array(width * height / 8);
            for (let i = 0; i < width * height; i++) {
                const byteIdx = Math.floor(i / 8);
                const bitIdx = 7 - (i % 8);
                if (gray[i] < 128) {
                    packed[byteIdx] &= ~(1 << bitIdx);
                } else {
                    packed[byteIdx] |= (1 << bitIdx);
                }
            }
            return packed;
        }
        
        // Audio Recording
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingStartTime = 0;
        let recordingTimer = null;
        
        async function startRecording() {
            if (!apiBase) {
                showSnackbar('Not connected');
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) recordedChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    stream.getTracks().forEach(track => track.stop());
                    if (recordedChunks.length > 0) {
                        const blob = new Blob(recordedChunks, { type: 'audio/webm' });
                        await sendVoiceMessage(blob);
                    }
                };
                
                mediaRecorder.start();
                recordingStartTime = Date.now();
                document.getElementById('recordBtn').style.backgroundColor = 'var(--md-sys-color-error)';
                document.getElementById('recordHint').style.display = 'none';
                document.getElementById('recordingTime').style.display = 'block';
                recordingTimer = setInterval(updateRecordingTime, 100);
            } catch (err) {
                showSnackbar('Recording failed');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            clearInterval(recordingTimer);
            document.getElementById('recordBtn').style.backgroundColor = '';
            document.getElementById('recordHint').style.display = 'block';
            document.getElementById('recordingTime').style.display = 'none';
            document.getElementById('recordingTime').textContent = '0:00';
        }
        
        function updateRecordingTime() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('recordingTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        async function sendVoiceMessage(blob) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const arrayBuffer = await blob.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer.slice(0));
                
                const sampleRate = 48000;
                const offlineContext = new OfflineAudioContext(1, audioBuffer.duration * sampleRate, sampleRate);
                const source = offlineContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(offlineContext.destination);
                source.start();
                
                const renderedBuffer = await offlineContext.startRendering();
                const floatData = renderedBuffer.getChannelData(0);
                const int16Data = new Int16Array(floatData.length);
                for (let i = 0; i < floatData.length; i++) {
                    int16Data[i] = Math.max(-32768, Math.min(32767, floatData[i] * 32767));
                }
                
                const wavBlob = createWavBlob(int16Data, sampleRate);
                const formData = new FormData();
                formData.append('file', wavBlob, 'voice_message.wav');
                
                const response = await fetch(`http://${apiBase}/api/audio/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showSnackbar('Voice message sent');
                }
            } catch (err) {
                showSnackbar('Failed to send voice message');
            }
        }
        
        function createWavBlob(int16Data, sampleRate) {
            const buffer = new ArrayBuffer(44 + int16Data.length * 2);
            const view = new DataView(buffer);
            
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + int16Data.length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, int16Data.length * 2, true);
            
            for (let i = 0; i < int16Data.length; i++) {
                view.setInt16(44 + i * 2, int16Data[i], true);
            }
            
            return new Blob([buffer], { type: 'audio/wav' });
        }
        
        async function uploadAudioFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch(`http://${apiBase}/api/audio/upload`, {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                showSnackbar('Audio file playing');
            }
            input.value = '';
        }
        
        // System
        async function refreshStatus() {
            const status = await apiCall('/api/status');
            if (status) {
                document.getElementById('esp32Status').textContent = status.esp32_status;
                document.getElementById('videoStatus').textContent = status.video_running ? 'Running' : 'Stopped';
                document.getElementById('audioStatus').textContent = status.audio_running ? 'Recording' : 'Stopped';
                document.getElementById('alarmStatus').textContent = status.alarm_state;
                updateAlarmDisplay(status.alarm_state);
            }
        }

        // Alarm Control Functions
        async function enableAlarm() {
            const result = await apiCall('/api/alarm/enable', 'POST');
            if (result && result.success) {
                showSnackbar('Alarm monitoring enabled');
                refreshStatus();
            }
        }

        async function disableAlarm() {
            const result = await apiCall('/api/alarm/disable', 'POST');
            if (result && result.success) {
                showSnackbar('Alarm monitoring disabled');
                refreshStatus();
            }
        }

        async function acknowledgeAlarm() {
            const result = await apiCall('/api/alarm/acknowledge', 'POST');
            if (result && result.success) {
                showSnackbar('Alarm acknowledged');
                refreshStatus();
            }
        }

        async function testAlarm() {
            const result = await apiCall('/api/alarm/test', 'POST');
            if (result && result.success) {
                showSnackbar('üß™ Test alarm triggered!');
                log('Test alarm triggered', 'success');
            }
        }

        async function loadAlarmConfig() {
            const config = await apiCall('/api/alarm/config');
            if (config) {
                document.getElementById('configThreshold').value = config.threshold || 0.8;
                document.getElementById('configDuration').value = config.detection_duration || 3;
                document.getElementById('alarmThreshold').textContent = config.threshold || '--';
                document.getElementById('alarmDuration').textContent = config.detection_duration || '--';
            }
        }

        async function updateAlarmConfig() {
            const threshold = parseFloat(document.getElementById('configThreshold').value);
            const duration = parseFloat(document.getElementById('configDuration').value);
            
            const result = await apiCall('/api/alarm/config', 'POST', {
                threshold: threshold,
                detection_duration: duration
            });
            
            if (result && result.success) {
                showSnackbar('Configuration saved');
                loadAlarmConfig();
            }
        }

        async function setWebhook() {
            const url = document.getElementById('webhookUrl').value.trim();
            if (!url) {
                showSnackbar('Please enter a webhook URL');
                return;
            }
            
            const result = await apiCall(`/api/alarm/webhook?url=${encodeURIComponent(url)}`, 'POST');
            if (result && result.success) {
                showSnackbar('Webhook configured');
            }
        }

        async function clearWebhook() {
            document.getElementById('webhookUrl').value = '';
            const result = await apiCall('/api/alarm/webhook?url=', 'POST');
            if (result && result.success) {
                showSnackbar('Webhook cleared');
            }
        }

        async function loadDetectionHistory() {
            const filter = document.getElementById('historyFilter').value;
            let url = '/api/alarm/history?limit=50';
            if (filter) {
                url += `&event_type=${filter}`;
            }
            
            const data = await apiCall(url);
            const historyList = document.getElementById('historyList');
            
            if (!data || !data.events || data.events.length === 0) {
                historyList.innerHTML = '<div style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: 20px;">No events recorded</div>';
                return;
            }
            
            historyList.innerHTML = data.events.map(event => {
                const date = new Date(event.timestamp);
                const timeStr = date.toLocaleTimeString();
                let icon = 'üìã';
                let color = '';
                
                if (event.event_type === 'alarm_triggered') {
                    icon = 'üö®';
                    color = 'color: var(--md-sys-color-error);';
                } else if (event.event_type.includes('crying')) {
                    icon = 'üë∂';
                    color = 'color: #ff9800;';
                }
                
                return `
                    <div style="padding: 8px; border-bottom: 1px solid var(--md-sys-color-outline-variant); font-size: 13px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span style="color: var(--md-sys-color-on-surface-variant);">${timeStr}</span>
                            <span style="${color} font-weight: 500;">${icon} ${event.event_type}</span>
                        </div>
                        <div style="display: flex; gap: 16px;">
                            ${event.confidence ? `<span>Confidence: ${Math.round(event.confidence * 100)}%</span>` : ''}
                            ${event.duration ? `<span>Duration: ${event.duration.toFixed(1)}s</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function clearHistory() {
            const result = await apiCall('/api/alarm/history/clear', 'POST');
            if (result && result.success) {
                document.getElementById('historyList').innerHTML = '<div style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: 20px;">History cleared</div>';
                showSnackbar('History cleared');
            }
        }

        function updateAlarmDisplay(state) {
            const panel = document.getElementById('alarmStatusPanel');
            const icon = document.getElementById('alarmIcon');
            const text = document.getElementById('alarmStateText');
            
            // Reset styles
            panel.style.backgroundColor = 'var(--md-sys-color-surface-variant)';
            panel.style.animation = 'none';
            
            switch(state) {
                case 'idle':
                    icon.textContent = 'üîá';
                    text.textContent = 'Idle - Monitoring';
                    break;
                case 'detecting':
                    icon.textContent = 'üëÇ';
                    text.textContent = 'Detecting Crying...';
                    panel.style.backgroundColor = '#fff3e0';
                    break;
                case 'confirmed':
                    icon.textContent = '‚ö†Ô∏è';
                    text.textContent = 'Crying Confirmed!';
                    panel.style.backgroundColor = '#ff9800';
                    break;
                case 'alarming':
                    icon.textContent = 'üö®';
                    text.textContent = 'ALARM TRIGGERED!';
                    panel.style.backgroundColor = 'var(--md-sys-color-error)';
                    panel.style.color = 'white';
                    panel.style.animation = 'pulse 1s infinite';
                    break;
                case 'cooldown':
                    icon.textContent = '‚è∏Ô∏è';
                    text.textContent = 'Cooldown';
                    panel.style.backgroundColor = '#eceff1';
                    break;
                case 'disabled':
                    icon.textContent = '‚ùå';
                    text.textContent = 'Disabled';
                    break;
                default:
                    icon.textContent = '‚ùì';
                    text.textContent = state || 'Unknown';
            }
        }

        // Auto-refresh status
        let statusRefreshInterval = null;

        function startAutoRefresh() {
            if (statusRefreshInterval) clearInterval(statusRefreshInterval);
            statusRefreshInterval = setInterval(() => {
                if (isConnected) {
                    refreshStatus();
                }
            }, 2000);
        }

        function stopAutoRefresh() {
            if (statusRefreshInterval) {
                clearInterval(statusRefreshInterval);
                statusRefreshInterval = null;
            }
        }

        // Override connect to start auto-refresh
        const originalConnect = connect;
        connect = async function() {
            await originalConnect();
            if (isConnected) {
                startAutoRefresh();
                loadAlarmConfig();
            }
        };
        
        // Main WebSocket for events
        let eventWs = null;

        function connectEventWebSocket() {
            if (!apiBase) return;
            
            const wsUrl = `ws://${apiBase}/ws`;
            eventWs = new WebSocket(wsUrl);
            
            eventWs.onopen = () => {
                log('Event WebSocket connected', 'success');
                // Subscribe to alarm events
                eventWs.send(JSON.stringify({
                    type: 'subscribe',
                    events: ['ALARM_TRIGGERED', 'SOUND_DETECTED']
                }));
            };
            
            eventWs.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketEvent(data);
                } catch (e) {
                    console.log('WS message:', event.data);
                }
            };
            
            eventWs.onclose = () => {
                log('Event WebSocket disconnected');
                // Try to reconnect after 5 seconds
                setTimeout(() => {
                    if (isConnected) connectEventWebSocket();
                }, 5000);
            };
            
            eventWs.onerror = (error) => {
                log('Event WebSocket error', 'error');
            };
        }

        function handleWebSocketEvent(data) {
            if (data.type === 'ALARM_TRIGGERED') {
                log(`üö® ALARM: ${data.data.state}`, 'error');
                updateAlarmDisplay('alarming');
                showSnackbar('üö® ALARM TRIGGERED!');
                // Refresh history after a short delay
                setTimeout(loadDetectionHistory, 1000);
            } else if (data.type === 'SOUND_DETECTED') {
                if (data.data.category === 'crying') {
                    log(`üë∂ Crying detected: ${Math.round(data.data.confidence * 100)}%`, 'warning');
                    updateAlarmDisplay('detecting');
                }
            }
        }

        // Override connect to also connect event WebSocket
        const originalConnectFunc = connect;
        connect = async function() {
            await originalConnectFunc();
            if (isConnected) {
                connectEventWebSocket();
            }
        };

        async function pingESP32() {
            const result = await apiCall('/api/system/ping', 'POST');
            if (result && result.success) {
                showSnackbar('ESP32 responded: ' + result.message);
            }
        }
        
        async function resetESP32() {
            if (confirm('Reset ESP32?')) {
                await apiCall('/api/system/reset', 'POST');
                showSnackbar('ESP32 reset sent');
            }
        }
    </script>
</body>
</html>
